app.controller("talentCalculatorController",function(e,t,n,l,a,s){e.classes=[],e.selectedClassId=0,e.selectedClass=null,e.isInspectingTalent=!1,e.inspectedTalent=null,e.talentTooltipPos={top:0,left:0},e.availablePoints=51,e.requiredLevel=9,e.totalPointsPerSpec=[0,0,0],e.selectedTalents=[[],[],[]],e.fetchClasses=function(){n.getClasses().then(function(t){e.classes=t.data.map(l.build),e.fetchSpecifications("Druid")},function(e){console.log(e)})},e.fetchSpecifications=function(t){n.getSpecifications(t).then(function(t){e.selectedClassId>0&&(e.getClassById(e.selectedClassId).isSelected=!1);var n=t.data;e.selectedClass=l.build(n.selectedClass),e.getClassById(e.selectedClass.id).isSelected=!0,e.selectedClassId=e.selectedClass.id,i()},function(e){console.log(e)})},e.getClassById=function(t){var n=_.find(e.classes,{id:t});return n||null},e.getTalentByColIndex=function(e,t){var n=_.find(t,{colIndex:e});return n||null},e.showTalentTooltip=function(n,l,a,i){e.isLoadingTooltip=!0;var o=e.selectedClass.specifications[l],c=e.getTalentByColIndex(i,o.talentRows[a]);e.inspectedTalent=s.build(c,e.selectedTalents[l],e.totalPointsPerSpec[l]),t(function(){var t=angular.element("#talent-tooltip").height(),l=angular.element(n.target).offset(),a=angular.element(document).scrollTop(),s=l.top-t-15;s=a>s?a+5:s,e.talentTooltipPos.top=s+"px",e.talentTooltipPos.left=l.left+50+"px",e.isInspectingTalent=!0,e.isLoadingTooltip=!1},30)},e.hideTalentTooltip=function(){e.isInspectingTalent=!1},e.addTalentPoint=function(t,n,l,s){if(!e.isLoadingTooltip&&e.inspectedTalent&&e.inspectedTalent.isLearnable&&!e.inspectedTalent.isMaxRank){var i=e.selectedClass.specifications[n],d=e.getTalentByColIndex(s,i.talentRows[l]);d.selectedRankNo+=1,1===d.selectedRankNo&&e.selectedTalents[n].push(d),angular.forEach(i.talentsWithRequirements,function(t){var l=_.find(a,{rowIndex:t.rowIndex});if(t.requiredTalent.id===d.id&&d.selectedRankNo===d.talentRanks.length&&e.totalPointsPerSpec[n]>=l.requiredNo){c(e.getTalentByColIndex(t.columnIndex,i.talentRows[t.rowIndex]),!0)}});o(n,function(t,n,l){if(t<n.requiredNo&&t+1===n.requiredNo){var a=l[n.rowIndex];angular.forEach(a,function(t){var n=!0;if(null!==t.requiredTalent){var l=_.find(e.selectedTalents[t.specIndex],{id:t.requiredTalent.id});n=l&&l.selectedRankNo===l.talentRanks.length}c(t,n)})}}),e.inspectedTalent.updateRankNo(d,e.selectedTalents[n],e.totalPointsPerSpec[n]),e.totalPointsPerSpec[n]+=1,e.availablePoints-=1,e.requiredLevel+=1}},e.removeTalentPoint=function(t,n,l,a){if(!e.isLoadingTooltip&&e.inspectedTalent&&e.inspectedTalent.isUnlearnable){var s=e.selectedClass.specifications[n],i=e.getTalentByColIndex(a,s.talentRows[l]);i.selectedRankNo-=1,0===i.selectedRankNo&&(d=i,r=n,e.selectedTalents[r]=e.selectedTalents[r].filter(function(e){return e.id!==d.id})),angular.forEach(s.talentsWithRequirements,function(t){if(t.requiredTalent.id===i.id&&i.selectedRankNo!==i.talentRanks.length){c(e.getTalentByColIndex(t.columnIndex,s.talentRows[t.rowIndex]),!1)}});o(n,function(e,t,n){e===t.requiredNo&&e-1<t.requiredNo&&angular.forEach(n[t.rowIndex],function(e){c(e,!1)})}),e.inspectedTalent.updateRankNo(i,e.selectedTalents[n],e.totalPointsPerSpec[n]),e.totalPointsPerSpec[n]-=1,e.availablePoints+=1,e.requiredLevel-=1}var d,r},e.resetSpecificationTree=function(t){var n=e.totalPointsPerSpec[t];o(t,function(e,t,n){angular.forEach(n[t.rowIndex],function(e){c(e,0===e.rowIndex&&null===e.requiredTalent,!0)})}),e.availablePoints+=n,e.requiredLevel-=n,e.totalPointsPerSpec[t]=0,e.selectedTalents[t]=[]},e.resetAllTalents=function(){for(var e=function(e,t,n){angular.forEach(n[t.rowIndex],function(e){c(e,0===e.rowIndex&&null===e.requiredTalent,!0)})},t=0;t<3;t++)o(t,e);i()};function i(){e.availablePoints=51,e.requiredLevel=9,e.totalPointsPerSpec=[0,0,0],e.selectedTalents=[[],[],[]]}function o(t,n){var l=e.totalPointsPerSpec[t],s=e.selectedClass.specifications[t].talentRows;angular.forEach(a,function(e){n(l,e,s)})}function c(e,t,n){e.isActive=t,e.selectedRankNo=n?0:e.selectedRankNo}e.fetchClasses()});